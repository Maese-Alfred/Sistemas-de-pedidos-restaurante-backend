# ============================================================================
# CI Pipeline — Sistemas de Pedidos Restaurante (Backend)
# ============================================================================
# Triggers: Push & PR to main and develop only
# Stages:  Build → Test + Coverage → SonarCloud Analysis
# Requirements:
#   - GitHub Secret: SONAR_TOKEN (from https://sonarcloud.io)
# ============================================================================

name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Cancel in-progress runs for the same branch/PR to save resources
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────
  # JOB 1: Build, Test, Coverage & Sonar
  # ──────────────────────────────────────────────
  build-and-test:
    name: Build & Test (Java 17)
    runs-on: ubuntu-latest

    steps:
      # ── Checkout ──
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for SonarCloud blame analysis

      # ── Java + Maven setup ──
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # ── Build & Test with Coverage ──
      # Runs: compile → test → jacoco:report → jacoco:check (70% line, 60% branch)
      - name: Build & run tests with coverage
        run: mvn --batch-mode --no-transfer-progress verify

      # ── Upload JaCoCo reports as artifacts ──
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: |
            order-service/target/site/jacoco/
            kitchen-worker/target/site/jacoco/
            report-service/target/site/jacoco/
          retention-days: 14

      # ── Upload test results for debugging ──
      - name: Upload test reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            order-service/target/surefire-reports/
            kitchen-worker/target/surefire-reports/
            report-service/target/surefire-reports/
          retention-days: 7

      # ── SonarCloud Analysis ──
      - name: SonarCloud Scan
        if: env.SONAR_TOKEN != ''
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: >
          mvn --batch-mode --no-transfer-progress
          org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
          -Dsonar.projectKey=Maese-Alfred_Sistemas-de-pedidos-restaurante-backend
          -Dsonar.organization=maese-alfred
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.java.binaries=target/classes
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

  # ──────────────────────────────────────────────
  # JOB 2: Validate Docker builds (main/develop only)
  # ──────────────────────────────────────────────
  docker-validate:
    name: Validate Docker Builds
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    strategy:
      matrix:
        service:
          - name: order-service
            dockerfile: order-service/Dockerfile
          - name: kitchen-worker
            dockerfile: kitchen-worker/Dockerfile
          - name: report-service
            dockerfile: report-service/Dockerfile

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Docker build — ${{ matrix.service.name }}
        run: |
          docker build \
            -f ${{ matrix.service.dockerfile }} \
            -t ${{ matrix.service.name }}:ci-test \
            .
